<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563EB">
    <title>Mon Profil ‚Äî MedHub</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè•</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #2563EB;
            --primary-light: #3B82F6;
            --primary-dark: #1D4ED8;
            --primary-glow: rgba(37, 99, 235, 0.25);
            --accent-teal: #0D9488;
            --success: #10B981;
            --error: #E11D48;
            --error-bg: #FFF1F2;
            --bg-primary: #F8FAFC;
            --bg-secondary: #FFFFFF;
            --bg-tertiary: #F1F5F9;
            --text-primary: #0F172A;
            --text-secondary: #475569;
            --text-muted: #94A3B8;
            --border: rgba(0, 0, 0, 0.08);
            --border-light: rgba(0, 0, 0, 0.05);
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.07), 0 2px 4px rgba(0,0,0,0.05);
            --shadow-lg: 0 12px 40px rgba(0,0,0,0.1), 0 4px 12px rgba(0,0,0,0.05);
            --shadow-xl: 0 25px 60px rgba(0,0,0,0.12), 0 10px 24px rgba(0,0,0,0.08);
            --radius-sm: 12px;
            --radius-md: 16px;
            --radius-lg: 24px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html, body {
            height: 100%;
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
        }

        .bg-decoration {
            position: fixed; inset: 0; overflow: hidden;
            pointer-events: none; z-index: 0;
        }
        .bg-gradient-orb {
            position: absolute; border-radius: 50%;
            filter: blur(80px); opacity: 0.5;
            animation: float 20s ease-in-out infinite;
        }
        .orb-1 {
            width: 600px; height: 600px;
            background: linear-gradient(135deg, rgba(37,99,235,0.15), rgba(59,130,246,0.1));
            top: -200px; right: -200px;
        }
        .orb-2 {
            width: 500px; height: 500px;
            background: linear-gradient(135deg, rgba(13,148,136,0.12), rgba(20,184,166,0.08));
            bottom: -150px; left: -150px; animation-delay: -7s;
        }
        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(-10px, 15px) scale(0.98); }
        }

        .profil-container {
            position: relative; z-index: 1;
            min-height: 100vh;
            padding: 2rem 1rem;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Header avec retour */
        .profil-header {
            display: flex; align-items: center;
            gap: 1rem; margin-bottom: 2rem;
        }
        .btn-back {
            width: 40px; height: 40px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; text-decoration: none;
            color: var(--text-secondary);
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
        }
        .btn-back:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        .btn-back svg { width: 20px; height: 20px; }
        .profil-header-title {
            font-size: 1.5rem; font-weight: 700;
            letter-spacing: -0.02em;
        }

        /* Avatar large */
        .profil-avatar-section {
            text-align: center; margin-bottom: 2rem;
        }
        .profil-avatar {
            width: 80px; height: 80px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 50%; display: inline-flex;
            align-items: center; justify-content: center;
            color: white; font-size: 1.75rem; font-weight: 700;
            box-shadow: var(--shadow-lg), 0 0 40px var(--primary-glow);
            margin-bottom: 0.75rem;
        }
        .profil-nom {
            font-size: 1.25rem; font-weight: 700;
        }
        .profil-email {
            font-size: 0.85rem; color: var(--text-muted);
            margin-top: 0.25rem;
        }

        /* Cartes de section */
        .profil-section {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 1.75rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-light);
            margin-bottom: 1.5rem;
        }
        .profil-section-title {
            font-size: 1rem; font-weight: 700;
            margin-bottom: 1.25rem;
            display: flex; align-items: center; gap: 0.5rem;
        }
        .profil-section-title svg {
            width: 20px; height: 20px; color: var(--primary);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        .form-group { margin-bottom: 1rem; }
        .form-label {
            display: block; font-size: 0.8rem;
            font-weight: 600; color: var(--text-muted);
            margin-bottom: 0.375rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }
        .form-input {
            width: 100%; padding: 0.75rem 1rem;
            border: 1.5px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 0.95rem; font-family: inherit;
            color: var(--text-primary);
            background: var(--bg-primary);
            transition: all 0.2s ease; outline: none;
        }
        .form-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-glow);
            background: white;
        }
        .form-input::placeholder { color: var(--text-muted); }
        .form-input:disabled {
            background: var(--bg-tertiary);
            color: var(--text-muted);
            cursor: not-allowed;
        }

        .form-select {
            width: 100%; padding: 0.75rem 1rem;
            border: 1.5px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 0.95rem; font-family: inherit;
            color: var(--text-primary);
            background: var(--bg-primary);
            transition: all 0.2s ease; outline: none;
            cursor: pointer; appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2394A3B8' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            padding-right: 2.5rem;
        }
        .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-glow);
            background-color: white;
        }

        .btn-save {
            width: 100%; padding: 0.875rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white; border: none; border-radius: var(--radius-sm);
            font-size: 0.95rem; font-weight: 600;
            font-family: inherit; cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-md), 0 4px 16px var(--primary-glow);
            margin-top: 0.5rem;
        }
        .btn-save:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg), 0 8px 24px var(--primary-glow);
        }
        .btn-save:disabled {
            opacity: 0.6; cursor: not-allowed; transform: none;
        }

        /* Section mot de passe */
        .btn-change-password {
            width: 100%; padding: 0.75rem;
            background: transparent; color: var(--primary);
            border: 1.5px solid var(--primary);
            border-radius: var(--radius-sm);
            font-size: 0.9rem; font-weight: 600;
            font-family: inherit; cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-change-password:hover {
            background: rgba(37, 99, 235, 0.05);
        }

        /* Alertes */
        .alert {
            padding: 0.75rem 1rem;
            border-radius: var(--radius-sm);
            font-size: 0.85rem; font-weight: 500;
            margin-bottom: 1rem;
            display: none; align-items: center; gap: 0.5rem;
        }
        .alert.visible { display: flex; }
        .alert-error {
            background: var(--error-bg);
            border: 1px solid rgba(225, 29, 72, 0.15);
            color: var(--error);
        }
        .alert-success {
            background: #F0FDF4;
            border: 1px solid rgba(16, 185, 129, 0.2);
            color: #065F46;
        }

        .spinner {
            display: inline-block; width: 18px; height: 18px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white; border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Chargement initial */
        .profil-loading {
            text-align: center; padding: 4rem 0;
            color: var(--text-muted);
        }
        .profil-loading .loading-spinner {
            width: 40px; height: 40px; margin: 0 auto 1rem;
            border: 3px solid rgba(37, 99, 235, 0.15);
            border-top-color: var(--primary); border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @media (max-width: 480px) {
            .form-row { grid-template-columns: 1fr; gap: 0; }
            .profil-section { padding: 1.25rem; border-radius: 20px; }
        }
    </style>
</head>
<body>
    <div class="bg-decoration">
        <div class="bg-gradient-orb orb-1"></div>
        <div class="bg-gradient-orb orb-2"></div>
    </div>

    <div class="profil-container">
        <!-- Header -->
        <div class="profil-header">
            <a href="./index.html" class="btn-back">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="15 18 9 12 15 6"/>
                </svg>
            </a>
            <h1 class="profil-header-title">Mon profil</h1>
        </div>

        <!-- Chargement -->
        <div id="profil-loading" class="profil-loading">
            <div class="loading-spinner"></div>
            <p>Chargement du profil...</p>
        </div>

        <!-- Contenu (masqu√© au chargement) -->
        <div id="profil-content" style="display: none;">
            <!-- Avatar et nom -->
            <div class="profil-avatar-section">
                <div class="profil-avatar" id="profil-avatar">?</div>
                <div class="profil-nom" id="profil-nom-affiche"></div>
                <div class="profil-email" id="profil-email-affiche"></div>
            </div>

            <!-- Alertes -->
            <div class="alert alert-error" id="alert-error" role="alert">
                <span id="error-message"></span>
            </div>
            <div class="alert alert-success" id="alert-success" role="status">
                <span id="success-message"></span>
            </div>

            <!-- Informations personnelles -->
            <div class="profil-section">
                <h2 class="profil-section-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                    Informations personnelles
                </h2>

                <form id="form-profil" novalidate>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="first_name">Pr√©nom</label>
                            <input class="form-input" type="text" id="first_name" name="first_name" placeholder="Pr√©nom">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="last_name">Nom</label>
                            <input class="form-input" type="text" id="last_name" name="last_name" placeholder="Nom">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="email">Email</label>
                        <input class="form-input" type="email" id="email" name="email" disabled>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="specialty">Sp√©cialit√©</label>
                        <select class="form-select" id="specialty" name="specialty">
                            <option value="">Non renseign√©e</option>
                            <option value="G√©riatrie">G√©riatrie</option>
                            <option value="M√©decine g√©n√©rale">M√©decine g√©n√©rale</option>
                            <option value="M√©decine interne">M√©decine interne</option>
                            <option value="Cardiologie">Cardiologie</option>
                            <option value="Neurologie">Neurologie</option>
                            <option value="Pneumologie">Pneumologie</option>
                            <option value="N√©phrologie">N√©phrologie</option>
                            <option value="Endocrinologie">Endocrinologie</option>
                            <option value="Rhumatologie">Rhumatologie</option>
                            <option value="Oncologie">Oncologie</option>
                            <option value="Psychiatrie">Psychiatrie</option>
                            <option value="Chirurgie">Chirurgie</option>
                            <option value="Urgences">Urgences</option>
                            <option value="R√©√©ducation">R√©√©ducation (MPR)</option>
                            <option value="Autre">Autre</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="hospital">H√¥pital / Clinique</label>
                        <input class="form-input" type="text" id="hospital" name="hospital"
                               placeholder="Nom de votre √©tablissement">
                    </div>

                    <button type="submit" class="btn-save" id="btn-save">
                        Enregistrer les modifications
                    </button>
                </form>
            </div>

            <!-- S√©curit√© -->
            <div class="profil-section">
                <h2 class="profil-section-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                    </svg>
                    S√©curit√©
                </h2>

                <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem;">
                    Modifiez votre mot de passe pour s√©curiser votre compte.
                </p>

                <div id="password-section" style="display: none;">
                    <div class="form-group">
                        <label class="form-label" for="new_password">Nouveau mot de passe</label>
                        <input class="form-input" type="password" id="new_password"
                               placeholder="Minimum 8 caract√®res" autocomplete="new-password">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="confirm_password">Confirmer</label>
                        <input class="form-input" type="password" id="confirm_password"
                               placeholder="Retapez le mot de passe" autocomplete="new-password">
                    </div>
                    <button type="button" class="btn-save" id="btn-save-password">
                        Mettre √† jour le mot de passe
                    </button>
                </div>

                <button type="button" class="btn-change-password" id="btn-toggle-password">
                    Changer le mot de passe
                </button>
            </div>
        </div>
    </div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="./js/supabase-config.js"></script>
    <script src="./js/auth-guard.js"></script>

    <script>
        // ==========================================
        // Logique de la page profil
        // ==========================================

        const loadingEl = document.getElementById('profil-loading');
        const contentEl = document.getElementById('profil-content');
        const form = document.getElementById('form-profil');
        const btnSave = document.getElementById('btn-save');
        const alertError = document.getElementById('alert-error');
        const errorMessage = document.getElementById('error-message');
        const alertSuccess = document.getElementById('alert-success');
        const successMessage = document.getElementById('success-message');

        function afficherErreur(msg) {
            errorMessage.textContent = msg;
            alertError.classList.add('visible');
            alertSuccess.classList.remove('visible');
        }

        function afficherSucces(msg) {
            successMessage.textContent = msg;
            alertSuccess.classList.add('visible');
            alertError.classList.remove('visible');
        }

        /**
         * Charger les donn√©es du profil
         */
        async function chargerProfil() {
            try {
                const { user } = await getUser();
                if (!user) return;

                const { profile } = await getProfil();

                // Remplir le formulaire
                document.getElementById('first_name').value = profile?.first_name || '';
                document.getElementById('last_name').value = profile?.last_name || '';
                document.getElementById('email').value = user.email || '';
                document.getElementById('specialty').value = profile?.specialty || '';
                document.getElementById('hospital').value = profile?.hospital || '';

                // Mettre √† jour l'avatar et le nom affich√©
                const prenom = profile?.first_name || '';
                const nom = profile?.last_name || '';
                const initiales = ((prenom[0] || '') + (nom[0] || '')).toUpperCase() || '?';

                document.getElementById('profil-avatar').textContent = initiales;
                document.getElementById('profil-nom-affiche').textContent =
                    (prenom && nom) ? `Dr. ${prenom} ${nom}` : user.email;
                document.getElementById('profil-email-affiche').textContent = user.email;

                // Afficher le contenu
                loadingEl.style.display = 'none';
                contentEl.style.display = 'block';

                // V√©rifier si on vient du reset password
                const params = new URLSearchParams(window.location.search);
                if (params.get('action') === 'reset-password') {
                    document.getElementById('password-section').style.display = 'block';
                    document.getElementById('btn-toggle-password').style.display = 'none';
                    afficherSucces('Vous pouvez maintenant d√©finir un nouveau mot de passe.');
                }

            } catch (err) {
                console.error('[Profil]', err);
                loadingEl.innerHTML = '<p style="color: var(--error);">Erreur lors du chargement du profil.</p>';
            }
        }

        /**
         * Sauvegarder les modifications du profil
         */
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            alertError.classList.remove('visible');
            alertSuccess.classList.remove('visible');

            const updates = {
                first_name: document.getElementById('first_name').value.trim(),
                last_name: document.getElementById('last_name').value.trim(),
                specialty: document.getElementById('specialty').value,
                hospital: document.getElementById('hospital').value.trim()
            };

            if (!updates.first_name || !updates.last_name) {
                afficherErreur('Le pr√©nom et le nom sont obligatoires.');
                return;
            }

            btnSave.disabled = true;
            btnSave.innerHTML = '<span class="spinner"></span>';

            try {
                const { data, error } = await mettreAJourProfil(updates);

                if (error) {
                    afficherErreur(traduireErreur(error));
                    return;
                }

                afficherSucces('Profil mis √† jour avec succ√®s.');

                // Mettre √† jour l'affichage
                const initiales = ((updates.first_name[0] || '') + (updates.last_name[0] || '')).toUpperCase();
                document.getElementById('profil-avatar').textContent = initiales;
                document.getElementById('profil-nom-affiche').textContent =
                    `Dr. ${updates.first_name} ${updates.last_name}`;

            } catch (err) {
                afficherErreur('Erreur lors de la sauvegarde.');
                console.error('[Profil Save]', err);
            } finally {
                btnSave.disabled = false;
                btnSave.textContent = 'Enregistrer les modifications';
            }
        });

        /**
         * Basculer la section mot de passe
         */
        document.getElementById('btn-toggle-password').addEventListener('click', () => {
            const section = document.getElementById('password-section');
            const visible = section.style.display === 'block';
            section.style.display = visible ? 'none' : 'block';
            document.getElementById('btn-toggle-password').textContent =
                visible ? 'Changer le mot de passe' : 'Annuler';
        });

        /**
         * Sauvegarder le nouveau mot de passe
         */
        document.getElementById('btn-save-password').addEventListener('click', async () => {
            alertError.classList.remove('visible');
            alertSuccess.classList.remove('visible');

            const newPassword = document.getElementById('new_password').value;
            const confirmPassword = document.getElementById('confirm_password').value;

            if (!newPassword || newPassword.length < 8) {
                afficherErreur('Le mot de passe doit contenir au moins 8 caract√®res.');
                return;
            }

            if (newPassword !== confirmPassword) {
                afficherErreur('Les mots de passe ne correspondent pas.');
                return;
            }

            const btn = document.getElementById('btn-save-password');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span>';

            try {
                const client = getSupabase();
                const { error } = await client.auth.updateUser({ password: newPassword });

                if (error) {
                    afficherErreur(traduireErreur(error));
                    return;
                }

                afficherSucces('Mot de passe mis √† jour avec succ√®s.');
                document.getElementById('new_password').value = '';
                document.getElementById('confirm_password').value = '';
                document.getElementById('password-section').style.display = 'none';
                document.getElementById('btn-toggle-password').textContent = 'Changer le mot de passe';
                document.getElementById('btn-toggle-password').style.display = '';

                // Retirer le param√®tre action de l'URL
                if (window.location.search.includes('action=reset-password')) {
                    window.history.replaceState({}, '', window.location.pathname);
                }

            } catch (err) {
                afficherErreur('Erreur lors de la mise √† jour du mot de passe.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Mettre √† jour le mot de passe';
            }
        });

        // Charger le profil au d√©marrage
        chargerProfil();
    </script>
</body>
</html>
