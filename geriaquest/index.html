<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#7C3AED">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>GeriaQuest - Cas Cliniques G√©riatrie</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéØ</text></svg>">
    <link rel="manifest" href="../manifest.json">
    <link rel="apple-touch-icon" href="../icon-192x192.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #7C3AED;
            --primary-light: #8B5CF6;
            --primary-lighter: #A78BFA;
            --primary-dark: #6D28D9;
            --primary-glow: rgba(124, 58, 237, 0.25);

            --accent-teal: #0D9488;
            --accent-blue: #2563EB;
            --accent-rose: #E11D48;

            --success: #10B981;
            --success-light: #34D399;
            --success-bg: rgba(16, 185, 129, 0.12);
            --warning: #F59E0B;
            --warning-bg: rgba(245, 158, 11, 0.12);
            --danger: #EF4444;
            --danger-bg: rgba(239, 68, 68, 0.12);

            --bg-primary: #F8FAFC;
            --bg-secondary: #FFFFFF;
            --bg-tertiary: #F1F5F9;
            --bg-glass: rgba(255, 255, 255, 0.8);

            --text-primary: #0F172A;
            --text-secondary: #475569;
            --text-muted: #94A3B8;

            --border: rgba(0, 0, 0, 0.08);
            --border-light: rgba(0, 0, 0, 0.05);

            --shadow-sm: 0 1px 3px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.07), 0 2px 4px rgba(0,0,0,0.05);
            --shadow-lg: 0 12px 40px rgba(0,0,0,0.1), 0 4px 12px rgba(0,0,0,0.05);
            --shadow-xl: 0 25px 60px rgba(0,0,0,0.12), 0 10px 24px rgba(0,0,0,0.08);

            --radius-sm: 12px;
            --radius-md: 16px;
            --radius-lg: 24px;
            --radius-xl: 32px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
        }

        /* Background */
        .bg-decoration {
            position: fixed;
            inset: 0;
            overflow: hidden;
            pointer-events: none;
            z-index: 0;
        }

        .bg-gradient-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.4;
            animation: float 20s ease-in-out infinite;
        }

        .orb-1 {
            width: 500px;
            height: 500px;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.2), rgba(139, 92, 246, 0.15));
            top: -150px;
            right: -150px;
        }

        .orb-2 {
            width: 400px;
            height: 400px;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(52, 211, 153, 0.1));
            bottom: -100px;
            left: -100px;
            animation-delay: -10s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(-20px, 20px) scale(1.05); }
        }

        /* App Container */
        .app {
            position: relative;
            z-index: 1;
            min-height: 100vh;
            max-width: 800px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* Header */
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0 1rem;
            margin-bottom: 1rem;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: 100px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .back-btn:hover {
            color: var(--primary);
            border-color: var(--primary-lighter);
            transform: translateX(-2px);
        }

        .back-btn svg {
            width: 16px;
            height: 16px;
        }

        .header-center {
            text-align: center;
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: -0.03em;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-subtitle {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .streak-badge {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.5rem 0.875rem;
            background: linear-gradient(135deg, #F59E0B, #D97706);
            border-radius: 100px;
            color: white;
            font-size: 0.8rem;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        /* Stats Bar */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            padding: 1rem;
            text-align: center;
            box-shadow: var(--shadow-sm);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
            letter-spacing: -0.02em;
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 0.25rem;
        }

        /* XP Progress */
        .xp-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-md);
        }

        .xp-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .level-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .level-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            box-shadow: var(--shadow-md), 0 0 20px var(--primary-glow);
        }

        .level-info h3 {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .level-info p {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .xp-count {
            text-align: right;
        }

        .xp-count .current {
            font-size: 1.1rem;
            font-weight: 800;
            color: var(--primary);
        }

        .xp-count .total {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .xp-bar {
            height: 12px;
            background: var(--bg-tertiary);
            border-radius: 100px;
            overflow: hidden;
            position: relative;
        }

        .xp-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            border-radius: 100px;
            transition: width 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
        }

        .xp-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Badges Section */
        .badges-section {
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .badges-grid {
            display: flex;
            gap: 0.75rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
            scrollbar-width: none;
        }

        .badges-grid::-webkit-scrollbar { display: none; }

        .badge-item {
            flex-shrink: 0;
            width: 70px;
            text-align: center;
        }

        .badge-icon {
            width: 56px;
            height: 56px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 0.375rem;
            font-size: 1.5rem;
            transition: all 0.3s ease;
        }

        .badge-item.unlocked .badge-icon {
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            border-color: var(--primary);
            box-shadow: 0 4px 16px var(--primary-glow);
        }

        .badge-item.locked .badge-icon {
            opacity: 0.4;
            filter: grayscale(1);
        }

        .badge-name {
            font-size: 0.65rem;
            font-weight: 600;
            color: var(--text-muted);
        }

        .badge-item.unlocked .badge-name {
            color: var(--text-primary);
        }

        /* Quiz Card */
        .quiz-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            margin-bottom: 1.5rem;
        }

        .quiz-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            padding: 1.25rem;
            color: white;
        }

        .quiz-category {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            background: rgba(255,255,255,0.2);
            border-radius: 100px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
        }

        .quiz-progress {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .quiz-body {
            padding: 1.5rem;
        }

        /* Case Presentation */
        .case-presentation {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--primary);
        }

        .case-title {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .case-text {
            font-size: 0.95rem;
            line-height: 1.7;
            color: var(--text-primary);
        }

        .case-text strong {
            color: var(--primary-dark);
        }

        /* Question */
        .question-text {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1.25rem;
            line-height: 1.4;
        }

        /* Options */
        .options-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .option-btn {
            width: 100%;
            padding: 1rem 1.25rem;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-md);
            text-align: left;
            font-family: inherit;
            font-size: 0.95rem;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .option-btn:hover:not(:disabled) {
            border-color: var(--primary-lighter);
            background: rgba(124, 58, 237, 0.05);
            transform: translateX(4px);
        }

        .option-btn:disabled {
            cursor: not-allowed;
        }

        .option-letter {
            flex-shrink: 0;
            width: 28px;
            height: 28px;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85rem;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .option-btn:hover:not(:disabled) .option-letter {
            border-color: var(--primary);
            color: var(--primary);
        }

        .option-btn.correct {
            border-color: var(--success);
            background: var(--success-bg);
        }

        .option-btn.correct .option-letter {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .option-btn.wrong {
            border-color: var(--danger);
            background: var(--danger-bg);
        }

        .option-btn.wrong .option-letter {
            background: var(--danger);
            border-color: var(--danger);
            color: white;
        }

        /* Explanation */
        .explanation {
            display: none;
            margin-top: 1.5rem;
            padding: 1.25rem;
            background: var(--success-bg);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: var(--radius-md);
            animation: slideIn 0.3s ease;
        }

        .explanation.show {
            display: block;
        }

        .explanation.wrong-answer {
            background: var(--danger-bg);
            border-color: rgba(239, 68, 68, 0.3);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .explanation-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .explanation-icon {
            width: 28px;
            height: 28px;
            background: var(--success);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.9rem;
        }

        .explanation.wrong-answer .explanation-icon {
            background: var(--danger);
        }

        .explanation-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--success);
        }

        .explanation.wrong-answer .explanation-title {
            color: var(--danger);
        }

        .explanation-text {
            font-size: 0.9rem;
            line-height: 1.6;
            color: var(--text-primary);
        }

        /* Schema/Diagram Styles */
        .schema-container {
            margin: 1rem 0;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-light);
            overflow-x: auto;
        }

        .schema-container svg {
            display: block;
            margin: 0 auto;
            max-width: 100%;
            height: auto;
        }

        .schema-title {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
            text-align: center;
        }

        .xp-gained {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            margin-top: 0.75rem;
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border-radius: 100px;
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        /* Next Button */
        .next-btn {
            display: none;
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border: none;
            border-radius: var(--radius-md);
            color: white;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1rem;
            box-shadow: var(--shadow-md), 0 0 30px var(--primary-glow);
        }

        .next-btn.show {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .next-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg), 0 0 40px var(--primary-glow);
        }

        .next-btn svg {
            width: 20px;
            height: 20px;
        }

        /* Start Screen */
        .start-screen {
            text-align: center;
            padding: 2rem 1rem;
        }

        .start-icon {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: var(--radius-xl);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 3rem;
            box-shadow: var(--shadow-xl), 0 0 60px var(--primary-glow);
            animation: bounce 2s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .start-title {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .start-subtitle {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        .start-btn {
            padding: 1rem 2.5rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border: none;
            border-radius: var(--radius-md);
            color: white;
            font-family: inherit;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-lg), 0 0 40px var(--primary-glow);
        }

        .start-btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: var(--shadow-xl), 0 0 60px var(--primary-glow);
        }

        /* Complete Screen */
        .complete-screen {
            display: none;
            text-align: center;
            padding: 2rem 1rem;
        }

        .complete-screen.show {
            display: block;
        }

        .complete-icon {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, var(--success), var(--success-light));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 3.5rem;
            box-shadow: 0 20px 60px rgba(16, 185, 129, 0.3);
            animation: scaleIn 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes scaleIn {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .complete-title {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .complete-stats {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin: 1.5rem 0;
        }

        .complete-stat {
            text-align: center;
        }

        .complete-stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary);
        }

        .complete-stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .restart-btn {
            padding: 1rem 2rem;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 1rem;
        }

        .restart-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--text-primary);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: var(--radius-md);
            font-weight: 600;
            box-shadow: var(--shadow-xl);
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
            visibility: visible;
        }

        .toast.success {
            background: linear-gradient(135deg, var(--success), #059669);
        }

        .toast.badge-toast {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        }

        /* Responsive */
        @media (max-width: 640px) {
            .app {
                padding: 0.75rem;
            }

            .stats-bar {
                gap: 0.5rem;
            }

            .stat-card {
                padding: 0.75rem;
            }

            .stat-value {
                font-size: 1.25rem;
            }

            .quiz-body {
                padding: 1.25rem;
            }

            .case-text {
                font-size: 0.9rem;
            }

            .question-text {
                font-size: 1rem;
            }

            .option-btn {
                padding: 0.875rem 1rem;
                font-size: 0.9rem;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .quiz-card {
            animation: fadeIn 0.4s ease;
        }
    </style>
</head>
<body>
    <!-- Background -->
    <div class="bg-decoration">
        <div class="bg-gradient-orb orb-1"></div>
        <div class="bg-gradient-orb orb-2"></div>
    </div>

    <div class="app">
        <!-- Header -->
        <header>
            <a href="../index.html" class="back-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                MedHub
            </a>
            <div class="header-center">
                <h1 class="logo-text">GeriaQuest</h1>
                <p class="header-subtitle">Cas cliniques g√©riatrie</p>
            </div>
            <div class="streak-badge" id="streakBadge">
                <span>üî•</span>
                <span id="streakCount">0</span>
            </div>
        </header>

        <!-- Stats Bar -->
        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-value" id="totalXP">0</div>
                <div class="stat-label">XP Total</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="correctAnswers">0</div>
                <div class="stat-label">Bonnes r√©p.</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="accuracy">0%</div>
                <div class="stat-label">Pr√©cision</div>
            </div>
        </div>

        <!-- XP Progress -->
        <div class="xp-section">
            <div class="xp-header">
                <div class="level-badge">
                    <div class="level-icon" id="levelIcon">ü©∫</div>
                    <div class="level-info">
                        <h3 id="levelName">Interne</h3>
                        <p id="levelSubtitle">Niveau 1</p>
                    </div>
                </div>
                <div class="xp-count">
                    <span class="current" id="currentXP">0</span>
                    <span class="total">/ <span id="nextLevelXP">100</span> XP</span>
                </div>
            </div>
            <div class="xp-bar">
                <div class="xp-fill" id="xpFill" style="width: 0%"></div>
            </div>
        </div>

        <!-- Badges Section -->
        <div class="badges-section">
            <h2 class="section-title">
                <span>üèÜ</span> Badges
            </h2>
            <div class="badges-grid" id="badgesGrid">
                <!-- Badges will be populated by JS -->
            </div>
        </div>

        <!-- Start Screen -->
        <div class="start-screen" id="startScreen">
            <div class="start-icon">üéØ</div>
            <h2 class="start-title">Pr√™t pour le d√©fi ?</h2>
            <p class="start-subtitle">10 cas cliniques vous attendent</p>
            <button class="start-btn" onclick="startQuiz()">
                Commencer la session
            </button>
        </div>

        <!-- Quiz Card -->
        <div class="quiz-card" id="quizCard" style="display: none;">
            <div class="quiz-header">
                <div class="quiz-category" id="quizCategory">
                    <span>üè•</span>
                    <span id="categoryName">Chargement...</span>
                </div>
                <div class="quiz-progress">
                    Question <span id="currentQuestion">1</span>/<span id="totalQuestions">10</span>
                </div>
            </div>
            <div class="quiz-body">
                <div class="case-presentation">
                    <div class="case-title">üìã Cas clinique</div>
                    <div class="case-text" id="caseText">
                        Chargement...
                    </div>
                </div>

                <div class="question-text" id="questionText">
                    Chargement...
                </div>

                <div class="options-list" id="optionsList">
                    <!-- Options will be populated by JS -->
                </div>

                <div class="explanation" id="explanation">
                    <div class="explanation-header">
                        <div class="explanation-icon" id="explanationIcon">‚úì</div>
                        <span class="explanation-title" id="explanationTitle">Bonne r√©ponse !</span>
                    </div>
                    <div class="explanation-text" id="explanationText">
                        Explication...
                    </div>
                    <div class="schema-container" id="schemaContainer" style="display: none;">
                        <div class="schema-title" id="schemaTitle"></div>
                        <div class="schema-content" id="schemaContent"></div>
                    </div>
                    <div class="xp-gained" id="xpGained">
                        +10 XP
                    </div>
                </div>

                <button class="next-btn" id="nextBtn" onclick="nextQuestion()">
                    Question suivante
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 12h14M12 5l7 7-7 7"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Complete Screen -->
        <div class="complete-screen" id="completeScreen">
            <div class="complete-icon">üéâ</div>
            <h2 class="complete-title">Session termin√©e !</h2>
            <div class="complete-stats">
                <div class="complete-stat">
                    <div class="complete-stat-value" id="finalCorrect">0</div>
                    <div class="complete-stat-label">Bonnes r√©ponses</div>
                </div>
                <div class="complete-stat">
                    <div class="complete-stat-value" id="finalXP">+0</div>
                    <div class="complete-stat-label">XP gagn√©s</div>
                </div>
            </div>
            <button class="restart-btn" onclick="restartQuiz()">
                üîÑ Nouvelle session
            </button>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // =============================================
        // GERIAQUEST - Clinical Cases Quiz System
        // =============================================

        // Levels Configuration
        const LEVELS = [
            { name: "Interne", icon: "ü©∫", minXP: 0, maxXP: 100 },
            { name: "Assistant", icon: "üë®‚Äç‚öïÔ∏è", minXP: 100, maxXP: 250 },
            { name: "Chef de clinique", icon: "üè•", minXP: 250, maxXP: 500 },
            { name: "PH", icon: "‚≠ê", minXP: 500, maxXP: 1000 },
            { name: "PU-PH", icon: "üéì", minXP: 1000, maxXP: 2000 },
            { name: "Expert G√©riatre", icon: "üëë", minXP: 2000, maxXP: Infinity }
        ];

        // Badges Configuration
        const BADGES = [
            { id: "first", name: "Premier pas", icon: "üåü", condition: (s) => s.totalAnswers >= 1 },
            { id: "streak3", name: "S√©rie de 3", icon: "üî•", condition: (s) => s.currentStreak >= 3 },
            { id: "streak5", name: "En feu !", icon: "üí•", condition: (s) => s.currentStreak >= 5 },
            { id: "perfect", name: "Sans faute", icon: "üíé", condition: (s) => s.perfectSessions >= 1 },
            { id: "xp100", name: "100 XP", icon: "üí™", condition: (s) => s.totalXP >= 100 },
            { id: "xp500", name: "500 XP", icon: "üöÄ", condition: (s) => s.totalXP >= 500 },
            { id: "cases10", name: "10 cas", icon: "üìö", condition: (s) => s.totalAnswers >= 10 },
            { id: "cases50", name: "50 cas", icon: "üèÜ", condition: (s) => s.totalAnswers >= 50 }
        ];

        // Clinical Cases Database
        const CASES = [
            {
                id: 1,
                category: "Chutes",
                case: "Mme Martin, <strong>82 ans</strong>, est adress√©e aux urgences pour une chute √† domicile. Elle vit seule, a chut√© en se levant la nuit pour aller aux toilettes. Ant√©c√©dents : HTA trait√©e par amlodipine 10mg, diab√®te type 2 sous metformine. PA couch√© 145/85, debout 110/70 mmHg.",
                question: "Quel est le diagnostic le plus probable pour expliquer cette chute ?",
                options: [
                    "Hypoglyc√©mie nocturne",
                    "Hypotension orthostatique",
                    "AVC isch√©mique",
                    "Trouble du rythme cardiaque"
                ],
                correct: 1,
                explanation: "La diff√©rence de PA > 20 mmHg systolique entre la position couch√©e et debout d√©finit l'hypotension orthostatique. L'amlodipine (inhibiteur calcique) est un facteur favorisant classique. Le lever nocturne est un moment √† risque typique chez le sujet √¢g√©.",
                diagram: {
                    title: "Diagnostic de l'hypotension orthostatique",
                    svg: `<svg viewBox="0 0 400 200" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="g1" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#10B981"/>
                                <stop offset="100%" style="stop-color:#059669"/>
                            </linearGradient>
                            <linearGradient id="g2" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#EF4444"/>
                                <stop offset="100%" style="stop-color:#DC2626"/>
                            </linearGradient>
                        </defs>
                        <!-- Couch√© -->
                        <rect x="30" y="40" width="120" height="100" rx="10" fill="#F1F5F9" stroke="#CBD5E1" stroke-width="2"/>
                        <text x="90" y="65" text-anchor="middle" font-size="12" font-weight="600" fill="#475569">COUCH√â</text>
                        <rect x="50" y="80" width="80" height="45" rx="6" fill="url(#g1)"/>
                        <text x="90" y="100" text-anchor="middle" font-size="11" fill="white" font-weight="600">145/85</text>
                        <text x="90" y="115" text-anchor="middle" font-size="9" fill="white">mmHg</text>
                        <!-- Fl√®che -->
                        <path d="M160 90 L200 90" stroke="#7C3AED" stroke-width="3" marker-end="url(#arrow)"/>
                        <text x="180" y="80" text-anchor="middle" font-size="10" fill="#7C3AED" font-weight="600">3 min</text>
                        <defs><marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="#7C3AED"/></marker></defs>
                        <!-- Debout -->
                        <rect x="210" y="40" width="120" height="100" rx="10" fill="#F1F5F9" stroke="#CBD5E1" stroke-width="2"/>
                        <text x="270" y="65" text-anchor="middle" font-size="12" font-weight="600" fill="#475569">DEBOUT</text>
                        <rect x="230" y="80" width="80" height="45" rx="6" fill="url(#g2)"/>
                        <text x="270" y="100" text-anchor="middle" font-size="11" fill="white" font-weight="600">110/70</text>
                        <text x="270" y="115" text-anchor="middle" font-size="9" fill="white">mmHg</text>
                        <!-- Delta -->
                        <rect x="340" y="70" width="55" height="50" rx="8" fill="#7C3AED"/>
                        <text x="367" y="92" text-anchor="middle" font-size="10" fill="white">Œî PAS</text>
                        <text x="367" y="108" text-anchor="middle" font-size="14" fill="white" font-weight="700">-35</text>
                        <!-- Crit√®res -->
                        <text x="200" y="170" text-anchor="middle" font-size="11" fill="#EF4444" font-weight="600">‚ö†Ô∏è Œî PAS ‚â• 20 mmHg = Hypotension orthostatique</text>
                        <text x="200" y="188" text-anchor="middle" font-size="10" fill="#64748B">Mesure √† 1 et 3 minutes apr√®s le lever</text>
                    </svg>`
                }
            },
            {
                id: 2,
                category: "Confusion",
                case: "M. Dupont, <strong>78 ans</strong>, est hospitalis√© pour pneumopathie. √Ä J3, l'infirmi√®re vous appelle car il est agit√©, d√©sorient√©, essaie d'arracher sa perfusion. Il √©tait parfaitement orient√© √† l'admission. Temp√©rature 38.2¬∞C.",
                question: "Quelle est la premi√®re hypoth√®se √† √©voquer ?",
                options: [
                    "D√©mence d√©butante",
                    "Syndrome confusionnel aigu (d√©lirium)",
                    "Accident vasculaire c√©r√©bral",
                    "Trouble psychiatrique"
                ],
                correct: 1,
                explanation: "Le caract√®re aigu et fluctuant, survenant chez un patient ant√©rieurement orient√©, dans un contexte infectieux, d√©finit le syndrome confusionnel aigu (d√©lirium). La d√©mence est chronique et progressive. L'infection est un facteur d√©clenchant majeur chez le sujet √¢g√©.",
                diagram: {
                    title: "D√©lirium vs D√©mence",
                    svg: `<svg viewBox="0 0 400 220" xmlns="http://www.w3.org/2000/svg">
                        <!-- Header -->
                        <rect x="10" y="10" width="180" height="30" rx="6" fill="#EF4444"/>
                        <text x="100" y="30" text-anchor="middle" font-size="12" fill="white" font-weight="700">D√âLIRIUM</text>
                        <rect x="210" y="10" width="180" height="30" rx="6" fill="#3B82F6"/>
                        <text x="300" y="30" text-anchor="middle" font-size="12" fill="white" font-weight="700">D√âMENCE</text>
                        <!-- Lignes -->
                        <line x1="200" y1="50" x2="200" y2="210" stroke="#E2E8F0" stroke-width="2"/>
                        <!-- D√©but -->
                        <text x="15" y="65" font-size="10" fill="#64748B" font-weight="600">D√©but</text>
                        <text x="100" y="65" text-anchor="middle" font-size="11" fill="#EF4444" font-weight="600">Aigu (heures/jours)</text>
                        <text x="300" y="65" text-anchor="middle" font-size="11" fill="#3B82F6" font-weight="600">Progressif (mois/ann√©es)</text>
                        <!-- √âvolution -->
                        <text x="15" y="90" font-size="10" fill="#64748B" font-weight="600">√âvolution</text>
                        <text x="100" y="90" text-anchor="middle" font-size="11" fill="#EF4444" font-weight="600">Fluctuant +++</text>
                        <text x="300" y="90" text-anchor="middle" font-size="11" fill="#3B82F6" font-weight="600">Stable sur la journ√©e</text>
                        <!-- Attention -->
                        <text x="15" y="115" font-size="10" fill="#64748B" font-weight="600">Attention</text>
                        <text x="100" y="115" text-anchor="middle" font-size="11" fill="#EF4444" font-weight="600">Tr√®s alt√©r√©e</text>
                        <text x="300" y="115" text-anchor="middle" font-size="11" fill="#3B82F6" font-weight="600">Relativement pr√©serv√©e</text>
                        <!-- Conscience -->
                        <text x="15" y="140" font-size="10" fill="#64748B" font-weight="600">Conscience</text>
                        <text x="100" y="140" text-anchor="middle" font-size="11" fill="#EF4444" font-weight="600">Alt√©r√©e</text>
                        <text x="300" y="140" text-anchor="middle" font-size="11" fill="#3B82F6" font-weight="600">Claire</text>
                        <!-- R√©versibilit√© -->
                        <text x="15" y="165" font-size="10" fill="#64748B" font-weight="600">R√©versibilit√©</text>
                        <text x="100" y="165" text-anchor="middle" font-size="11" fill="#10B981" font-weight="600">‚úì R√©versible</text>
                        <text x="300" y="165" text-anchor="middle" font-size="11" fill="#EF4444" font-weight="600">‚úó Irr√©versible</text>
                        <!-- Facteur -->
                        <rect x="50" y="180" width="300" height="30" rx="6" fill="#FEF3C7" stroke="#F59E0B"/>
                        <text x="200" y="200" text-anchor="middle" font-size="11" fill="#92400E" font-weight="600">üîç Toujours chercher une cause : infection, iatrog√©nie, douleur...</text>
                    </svg>`
                }
            },
            {
                id: 3,
                category: "D√©nutrition",
                case: "Mme Bernard, <strong>85 ans</strong>, consulte pour asth√©nie. Elle vit seule depuis le d√©c√®s de son mari il y a 6 mois. Poids actuel 48 kg pour 1m60, perte de 6 kg en 3 mois. Albumine : 28 g/L.",
                question: "Selon les crit√®res HAS 2021, quel est le diagnostic nutritionnel ?",
                options: [
                    "Pas de d√©nutrition",
                    "D√©nutrition mod√©r√©e",
                    "D√©nutrition s√©v√®re",
                    "Risque de d√©nutrition"
                ],
                correct: 2,
                explanation: "Crit√®res HAS 2021 de d√©nutrition s√©v√®re chez > 70 ans : perte de poids ‚â• 10% en 6 mois OU IMC < 20 OU albumine < 30 g/L. Ici : perte de 11% en 3 mois, IMC = 18.8, albumine = 28 g/L. Plusieurs crit√®res de s√©v√©rit√© sont pr√©sents.",
                diagram: {
                    title: "Crit√®res HAS 2021 - D√©nutrition > 70 ans",
                    svg: `<svg viewBox="0 0 400 200" xmlns="http://www.w3.org/2000/svg">
                        <!-- Header -->
                        <rect x="10" y="10" width="380" height="25" rx="6" fill="#7C3AED"/>
                        <text x="200" y="27" text-anchor="middle" font-size="11" fill="white" font-weight="700">CRIT√àRES PH√âNOTYPIQUES (‚â• 1 crit√®re = d√©nutrition)</text>
                        <!-- Colonnes -->
                        <rect x="10" y="45" width="125" height="25" rx="4" fill="#F59E0B"/>
                        <text x="72" y="62" text-anchor="middle" font-size="10" fill="white" font-weight="600">CRIT√àRE</text>
                        <rect x="140" y="45" width="120" height="25" rx="4" fill="#F59E0B"/>
                        <text x="200" y="62" text-anchor="middle" font-size="10" fill="white" font-weight="600">MOD√âR√âE</text>
                        <rect x="265" y="45" width="125" height="25" rx="4" fill="#EF4444"/>
                        <text x="327" y="62" text-anchor="middle" font-size="10" fill="white" font-weight="600">S√âV√àRE</text>
                        <!-- Ligne 1 -->
                        <rect x="10" y="75" width="125" height="35" fill="#F8FAFC" stroke="#E2E8F0"/>
                        <text x="72" y="97" text-anchor="middle" font-size="9" fill="#475569" font-weight="600">Perte de poids</text>
                        <rect x="140" y="75" width="120" height="35" fill="#FEF3C7" stroke="#E2E8F0"/>
                        <text x="200" y="92" text-anchor="middle" font-size="9" fill="#92400E">‚â• 5% en 1 mois</text>
                        <text x="200" y="104" text-anchor="middle" font-size="9" fill="#92400E">‚â• 10% en 6 mois</text>
                        <rect x="265" y="75" width="125" height="35" fill="#FEE2E2" stroke="#E2E8F0"/>
                        <text x="327" y="92" text-anchor="middle" font-size="9" fill="#991B1B">‚â• 10% en 1 mois</text>
                        <text x="327" y="104" text-anchor="middle" font-size="9" fill="#991B1B">‚â• 15% en 6 mois</text>
                        <!-- Ligne 2 -->
                        <rect x="10" y="115" width="125" height="30" fill="#F8FAFC" stroke="#E2E8F0"/>
                        <text x="72" y="135" text-anchor="middle" font-size="9" fill="#475569" font-weight="600">IMC</text>
                        <rect x="140" y="115" width="120" height="30" fill="#FEF3C7" stroke="#E2E8F0"/>
                        <text x="200" y="135" text-anchor="middle" font-size="9" fill="#92400E">&lt; 22</text>
                        <rect x="265" y="115" width="125" height="30" fill="#FEE2E2" stroke="#E2E8F0"/>
                        <text x="327" y="135" text-anchor="middle" font-size="9" fill="#991B1B">&lt; 20</text>
                        <!-- Ligne 3 -->
                        <rect x="10" y="150" width="125" height="30" fill="#F8FAFC" stroke="#E2E8F0"/>
                        <text x="72" y="170" text-anchor="middle" font-size="9" fill="#475569" font-weight="600">Albumine</text>
                        <rect x="140" y="150" width="120" height="30" fill="#FEF3C7" stroke="#E2E8F0"/>
                        <text x="200" y="170" text-anchor="middle" font-size="9" fill="#92400E">&lt; 35 g/L</text>
                        <rect x="265" y="150" width="125" height="30" fill="#FEE2E2" stroke="#E2E8F0"/>
                        <text x="327" y="170" text-anchor="middle" font-size="9" fill="#991B1B">&lt; 30 g/L</text>
                        <!-- Case patient -->
                        <rect x="280" y="150" width="100" height="30" fill="none" stroke="#EF4444" stroke-width="3" rx="4"/>
                    </svg>`
                }
            },
            {
                id: 4,
                category: "Iatrog√©nie",
                case: "M. Lambert, <strong>88 ans</strong>, est hospitalis√© pour malaise avec bradycardie √† 42/min. Traitement habituel : bisoprolol 10mg, verapamil 240mg LP, digoxine 0.25mg, p√©rindopril 4mg.",
                question: "Quelle association m√©dicamenteuse est particuli√®rement √† risque ici ?",
                options: [
                    "P√©rindopril + bisoprolol",
                    "Bisoprolol + verapamil",
                    "Digoxine + p√©rindopril",
                    "Verapamil + digoxine"
                ],
                correct: 1,
                explanation: "L'association b√™ta-bloquant + inhibiteur calcique bradycardisant (verapamil/diltiazem) est contre-indiqu√©e car elle majore le risque de bradycardie s√©v√®re et de BAV. La digoxine ajoute un risque suppl√©mentaire. Cette association est une cause classique d'hospitalisation iatrog√®ne chez le sujet √¢g√©.",
                diagram: {
                    title: "Interactions bradycardisantes",
                    svg: `<svg viewBox="0 0 400 200" xmlns="http://www.w3.org/2000/svg">
                        <!-- Coeur central -->
                        <circle cx="200" cy="100" r="40" fill="#FEE2E2" stroke="#EF4444" stroke-width="3"/>
                        <text x="200" y="95" text-anchor="middle" font-size="20">‚ù§Ô∏è</text>
                        <text x="200" y="115" text-anchor="middle" font-size="10" fill="#991B1B" font-weight="700">42 bpm</text>
                        <!-- Bisoprolol -->
                        <rect x="20" y="30" width="100" height="50" rx="8" fill="#3B82F6"/>
                        <text x="70" y="52" text-anchor="middle" font-size="9" fill="white" font-weight="600">BISOPROLOL</text>
                        <text x="70" y="68" text-anchor="middle" font-size="8" fill="#BFDBFE">Œ≤-bloquant</text>
                        <line x1="120" y1="55" x2="160" y2="85" stroke="#3B82F6" stroke-width="2"/>
                        <!-- Verapamil -->
                        <rect x="280" y="30" width="100" height="50" rx="8" fill="#8B5CF6"/>
                        <text x="330" y="52" text-anchor="middle" font-size="9" fill="white" font-weight="600">VERAPAMIL</text>
                        <text x="330" y="68" text-anchor="middle" font-size="8" fill="#DDD6FE">ICa bradycardisant</text>
                        <line x1="280" y1="55" x2="240" y2="85" stroke="#8B5CF6" stroke-width="2"/>
                        <!-- Interaction -->
                        <rect x="130" y="5" width="140" height="25" rx="12" fill="#EF4444"/>
                        <text x="200" y="22" text-anchor="middle" font-size="10" fill="white" font-weight="700">‚ö†Ô∏è CONTRE-INDIQU√â</text>
                        <!-- Digoxine -->
                        <rect x="20" y="120" width="100" height="50" rx="8" fill="#F59E0B"/>
                        <text x="70" y="142" text-anchor="middle" font-size="9" fill="white" font-weight="600">DIGOXINE</text>
                        <text x="70" y="158" text-anchor="middle" font-size="8" fill="#FEF3C7">Inotrope +</text>
                        <line x1="120" y1="145" x2="160" y2="115" stroke="#F59E0B" stroke-width="2" stroke-dasharray="5,3"/>
                        <!-- P√©rindopril -->
                        <rect x="280" y="120" width="100" height="50" rx="8" fill="#10B981"/>
                        <text x="330" y="142" text-anchor="middle" font-size="9" fill="white" font-weight="600">P√âRINDOPRIL</text>
                        <text x="330" y="158" text-anchor="middle" font-size="8" fill="#D1FAE5">IEC</text>
                        <line x1="280" y1="145" x2="240" y2="115" stroke="#10B981" stroke-width="2" stroke-dasharray="5,3"/>
                        <!-- L√©gende -->
                        <rect x="100" y="180" width="200" height="18" rx="4" fill="#F1F5F9"/>
                        <text x="200" y="193" text-anchor="middle" font-size="9" fill="#64748B">Trait plein = interaction majeure</text>
                    </svg>`
                }
            },
            {
                id: 5,
                category: "IRC",
                case: "Mme Petit, <strong>80 ans</strong>, est suivie pour HTA et diab√®te. Cr√©atinine : 142 ¬µmol/L, DFG selon CKD-EPI : 32 mL/min/1.73m¬≤. Elle prend metformine 1000mg x2, ramipril 5mg, furos√©mide 40mg.",
                question: "Quelle adaptation th√©rapeutique est n√©cessaire ?",
                options: [
                    "Arr√™t du ramipril",
                    "Arr√™t de la metformine",
                    "R√©duction de la metformine √† 500mg x2",
                    "Doublement du furos√©mide"
                ],
                correct: 2,
                explanation: "Pour un DFG entre 30-45 mL/min, la metformine doit √™tre r√©duite de moiti√© (max 1000mg/j). En dessous de 30 mL/min, elle doit √™tre arr√™t√©e. Le ramipril est n√©phroprotecteur et doit √™tre maintenu sauf hyperkali√©mie ou d√©gradation aigu√´ de la fonction r√©nale.",
                diagram: {
                    title: "Adaptation de la Metformine selon le DFG",
                    svg: `<svg viewBox="0 0 400 180" xmlns="http://www.w3.org/2000/svg">
                        <!-- Axe -->
                        <line x1="50" y1="130" x2="380" y2="130" stroke="#CBD5E1" stroke-width="2"/>
                        <text x="215" y="165" text-anchor="middle" font-size="10" fill="#64748B">DFG (mL/min/1.73m¬≤)</text>
                        <!-- Zone verte -->
                        <rect x="280" y="40" width="100" height="80" fill="#D1FAE5" rx="8"/>
                        <text x="330" y="70" text-anchor="middle" font-size="10" fill="#059669" font-weight="600">‚â• 60</text>
                        <text x="330" y="90" text-anchor="middle" font-size="9" fill="#059669">Dose normale</text>
                        <text x="330" y="105" text-anchor="middle" font-size="11" fill="#059669" font-weight="700">2000 mg/j</text>
                        <!-- Zone jaune -->
                        <rect x="160" y="40" width="115" height="80" fill="#FEF3C7" rx="8"/>
                        <text x="217" y="70" text-anchor="middle" font-size="10" fill="#D97706" font-weight="600">45-60</text>
                        <text x="217" y="90" text-anchor="middle" font-size="9" fill="#D97706">Surveillance</text>
                        <text x="217" y="105" text-anchor="middle" font-size="11" fill="#D97706" font-weight="700">2000 mg/j</text>
                        <!-- Zone orange -->
                        <rect x="90" y="40" width="65" height="80" fill="#FFEDD5" stroke="#F97316" stroke-width="2" rx="8"/>
                        <text x="122" y="70" text-anchor="middle" font-size="10" fill="#EA580C" font-weight="600">30-45</text>
                        <text x="122" y="90" text-anchor="middle" font-size="9" fill="#EA580C">R√©duire</text>
                        <text x="122" y="105" text-anchor="middle" font-size="11" fill="#EA580C" font-weight="700">1000 mg/j</text>
                        <!-- Zone rouge -->
                        <rect x="20" y="40" width="65" height="80" fill="#FEE2E2" rx="8"/>
                        <text x="52" y="70" text-anchor="middle" font-size="10" fill="#DC2626" font-weight="600">&lt; 30</text>
                        <text x="52" y="90" text-anchor="middle" font-size="9" fill="#DC2626" font-weight="700">STOP</text>
                        <text x="52" y="105" text-anchor="middle" font-size="14" fill="#DC2626">üö´</text>
                        <!-- Marqueur patient -->
                        <circle cx="110" cy="130" r="8" fill="#7C3AED"/>
                        <text x="110" y="155" text-anchor="middle" font-size="9" fill="#7C3AED" font-weight="600">DFG = 32</text>
                        <!-- Graduations -->
                        <text x="52" y="145" text-anchor="middle" font-size="8" fill="#94A3B8">15</text>
                        <text x="90" y="145" text-anchor="middle" font-size="8" fill="#94A3B8">30</text>
                        <text x="160" y="145" text-anchor="middle" font-size="8" fill="#94A3B8">45</text>
                        <text x="280" y="145" text-anchor="middle" font-size="8" fill="#94A3B8">60</text>
                        <text x="370" y="145" text-anchor="middle" font-size="8" fill="#94A3B8">90+</text>
                    </svg>`
                }
            },
            {
                id: 6,
                category: "Troubles cognitifs",
                case: "M. Moreau, <strong>76 ans</strong>, est amen√© par sa femme qui rapporte des oublis progressifs depuis 2 ans : il r√©p√®te les m√™mes questions, a perdu sa carte bancaire 3 fois. MMS : 22/30, horloge perturb√©e. Pas de troubles de la marche, pas d'incontinence.",
                question: "Quel diagnostic √©voquez-vous en premier lieu ?",
                options: [
                    "Hydroc√©phalie √† pression normale",
                    "Maladie d'Alzheimer",
                    "D√©mence vasculaire",
                    "D√©pression du sujet √¢g√©"
                ],
                correct: 1,
                explanation: "L'installation progressive des troubles mn√©siques (oubli des faits r√©cents, r√©p√©tition des questions), l'atteinte des fonctions ex√©cutives (horloge), sans troubles moteurs ni sphinct√©riens, oriente vers une maladie d'Alzheimer. La triade de Hakim (troubles cognitifs, marche, sphincters) √©voquerait une HPN.",
                diagram: {
                    title: "Triade de Hakim (HPN) vs Alzheimer",
                    svg: `<svg viewBox="0 0 400 200" xmlns="http://www.w3.org/2000/svg">
                        <!-- HPN -->
                        <text x="100" y="25" text-anchor="middle" font-size="12" fill="#3B82F6" font-weight="700">HPN</text>
                        <circle cx="100" cy="100" r="70" fill="none" stroke="#3B82F6" stroke-width="2" stroke-dasharray="5,3"/>
                        <text x="100" y="60" text-anchor="middle" font-size="9" fill="#3B82F6" font-weight="600">üß† Troubles</text>
                        <text x="100" y="73" text-anchor="middle" font-size="9" fill="#3B82F6">cognitifs</text>
                        <text x="55" y="115" text-anchor="middle" font-size="9" fill="#3B82F6" font-weight="600">üö∂ Troubles</text>
                        <text x="55" y="128" text-anchor="middle" font-size="9" fill="#3B82F6">marche</text>
                        <text x="145" y="115" text-anchor="middle" font-size="9" fill="#3B82F6" font-weight="600">üíß Troubles</text>
                        <text x="145" y="128" text-anchor="middle" font-size="9" fill="#3B82F6">sphincters</text>
                        <text x="100" y="155" text-anchor="middle" font-size="8" fill="#64748B">Triade de Hakim</text>
                        <!-- VS -->
                        <text x="200" y="100" text-anchor="middle" font-size="14" fill="#94A3B8" font-weight="700">VS</text>
                        <!-- Alzheimer -->
                        <text x="300" y="25" text-anchor="middle" font-size="12" fill="#10B981" font-weight="700">ALZHEIMER</text>
                        <circle cx="300" cy="100" r="70" fill="#D1FAE5" stroke="#10B981" stroke-width="2"/>
                        <text x="300" y="80" text-anchor="middle" font-size="9" fill="#059669" font-weight="600">üß† Troubles mn√©siques</text>
                        <text x="300" y="95" text-anchor="middle" font-size="9" fill="#059669">progressifs</text>
                        <text x="300" y="115" text-anchor="middle" font-size="9" fill="#059669">‚úì Marche normale</text>
                        <text x="300" y="130" text-anchor="middle" font-size="9" fill="#059669">‚úì Sphincters OK</text>
                        <!-- Patient -->
                        <rect x="250" y="165" width="100" height="25" rx="6" fill="#10B981"/>
                        <text x="300" y="182" text-anchor="middle" font-size="9" fill="white" font-weight="600">Ce patient ‚úì</text>
                    </svg>`
                }
            },
            {
                id: 7,
                category: "An√©mie",
                case: "Mme Durand, <strong>84 ans</strong>, consulte pour fatigue. Hb : 9.8 g/dL, VGM : 72 fL, ferritine : 8 ¬µg/L, CRP : 5 mg/L. Elle prend om√©prazole 20mg depuis 10 ans pour RGO.",
                question: "Quelle est l'√©tiologie la plus probable de cette an√©mie ?",
                options: [
                    "Carence martiale par saignement digestif occulte",
                    "An√©mie inflammatoire",
                    "Carence en B12 par IPP au long cours",
                    "Syndrome my√©lodysplasique"
                ],
                correct: 0,
                explanation: "An√©mie microcytaire (VGM < 80) + ferritine basse = carence martiale. Chez le sujet √¢g√©, la cause principale est le saignement digestif occulte (cancer colorectal √† rechercher ++). L'IPP favorise la malabsorption du fer mais aussi de la B12 (qui donne une an√©mie macrocytaire).",
                diagram: {
                    title: "Algorithme diagnostique des an√©mies",
                    svg: `<svg viewBox="0 0 400 220" xmlns="http://www.w3.org/2000/svg">
                        <!-- Start -->
                        <rect x="150" y="5" width="100" height="30" rx="6" fill="#7C3AED"/>
                        <text x="200" y="25" text-anchor="middle" font-size="10" fill="white" font-weight="600">AN√âMIE</text>
                        <line x1="200" y1="35" x2="200" y2="50" stroke="#7C3AED" stroke-width="2"/>
                        <!-- VGM -->
                        <rect x="130" y="50" width="140" height="25" rx="6" fill="#F1F5F9" stroke="#7C3AED"/>
                        <text x="200" y="67" text-anchor="middle" font-size="10" fill="#7C3AED" font-weight="600">VGM ?</text>
                        <!-- Branches -->
                        <line x1="130" y1="75" x2="60" y2="100" stroke="#CBD5E1" stroke-width="2"/>
                        <line x1="200" y1="75" x2="200" y2="100" stroke="#CBD5E1" stroke-width="2"/>
                        <line x1="270" y1="75" x2="340" y2="100" stroke="#7C3AED" stroke-width="3"/>
                        <!-- Macrocytaire -->
                        <rect x="10" y="100" width="100" height="40" rx="6" fill="#DBEAFE"/>
                        <text x="60" y="117" text-anchor="middle" font-size="9" fill="#1E40AF" font-weight="600">&gt; 100 fL</text>
                        <text x="60" y="132" text-anchor="middle" font-size="8" fill="#1E40AF">Macrocytaire</text>
                        <text x="60" y="155" text-anchor="middle" font-size="8" fill="#64748B">B12, folates</text>
                        <!-- Normocytaire -->
                        <rect x="140" y="100" width="120" height="40" rx="6" fill="#FEF3C7"/>
                        <text x="200" y="117" text-anchor="middle" font-size="9" fill="#92400E" font-weight="600">80-100 fL</text>
                        <text x="200" y="132" text-anchor="middle" font-size="8" fill="#92400E">Normocytaire</text>
                        <text x="200" y="155" text-anchor="middle" font-size="8" fill="#64748B">Inflam, IRC, h√©molyse</text>
                        <!-- Microcytaire -->
                        <rect x="290" y="100" width="100" height="40" rx="6" fill="#DCFCE7" stroke="#10B981" stroke-width="2"/>
                        <text x="340" y="117" text-anchor="middle" font-size="9" fill="#166534" font-weight="600">&lt; 80 fL</text>
                        <text x="340" y="132" text-anchor="middle" font-size="8" fill="#166534">Microcytaire</text>
                        <!-- Ferritine -->
                        <line x1="340" y1="140" x2="340" y2="160" stroke="#10B981" stroke-width="2"/>
                        <rect x="290" y="160" width="100" height="25" rx="4" fill="#10B981"/>
                        <text x="340" y="177" text-anchor="middle" font-size="9" fill="white" font-weight="600">Ferritine ‚Üì‚Üì</text>
                        <!-- Conclusion -->
                        <rect x="260" y="190" width="130" height="25" rx="6" fill="#EF4444"/>
                        <text x="325" y="207" text-anchor="middle" font-size="9" fill="white" font-weight="700">CARENCE MARTIALE</text>
                        <line x1="340" y1="185" x2="325" y2="190" stroke="#EF4444" stroke-width="2"/>
                    </svg>`
                }
            },
            {
                id: 8,
                category: "Fragilit√©",
                case: "M. Garcia, <strong>79 ans</strong>, vient pour bilan. Il rapporte une fatigue, une perte de poids de 4kg en 1 an, une diminution de sa vitesse de marche. Il sort peu de chez lui. Pas de comorbidit√© connue.",
                question: "Combien de crit√®res de Fried sont pr√©sents ici ?",
                options: [
                    "1 crit√®re - Robuste",
                    "2 crit√®res - Pr√©-fragile",
                    "3 crit√®res - Fragile",
                    "4 crit√®res - Tr√®s fragile"
                ],
                correct: 2,
                explanation: "Crit√®res de Fried : 1) Perte de poids involontaire ‚úì, 2) Fatigue subjective ‚úì, 3) Vitesse de marche lente ‚úì, 4) Faible activit√© physique (sort peu) ‚úì, 5) Force de pr√©hension diminu√©e (?). Avec au moins 3 crit√®res, il est consid√©r√© comme fragile. 1-2 crit√®res = pr√©-fragile.",
                diagram: {
                    title: "Les 5 crit√®res de Fried",
                    svg: `<svg viewBox="0 0 400 200" xmlns="http://www.w3.org/2000/svg">
                        <!-- Pentagone central -->
                        <polygon points="200,30 280,75 260,155 140,155 120,75" fill="#F1F5F9" stroke="#7C3AED" stroke-width="2"/>
                        <text x="200" y="100" text-anchor="middle" font-size="12" fill="#7C3AED" font-weight="700">FRAGILIT√â</text>
                        <!-- Crit√®re 1 - Poids -->
                        <circle cx="200" cy="15" r="20" fill="#10B981"/>
                        <text x="200" y="20" text-anchor="middle" font-size="12" fill="white">‚öñÔ∏è</text>
                        <text x="200" y="55" text-anchor="middle" font-size="8" fill="#10B981" font-weight="600">Perte poids ‚úì</text>
                        <!-- Crit√®re 2 - Fatigue -->
                        <circle cx="295" cy="65" r="20" fill="#10B981"/>
                        <text x="295" y="70" text-anchor="middle" font-size="12" fill="white">üò¥</text>
                        <text x="330" y="90" text-anchor="middle" font-size="8" fill="#10B981" font-weight="600">Fatigue ‚úì</text>
                        <!-- Crit√®re 3 - Activit√© -->
                        <circle cx="270" cy="165" r="20" fill="#10B981"/>
                        <text x="270" y="170" text-anchor="middle" font-size="12" fill="white">üèÉ</text>
                        <text x="310" y="185" text-anchor="middle" font-size="8" fill="#10B981" font-weight="600">Activit√© ‚Üì ‚úì</text>
                        <!-- Crit√®re 4 - Marche -->
                        <circle cx="130" cy="165" r="20" fill="#10B981"/>
                        <text x="130" y="170" text-anchor="middle" font-size="12" fill="white">üö∂</text>
                        <text x="90" y="185" text-anchor="middle" font-size="8" fill="#10B981" font-weight="600">Marche ‚Üì ‚úì</text>
                        <!-- Crit√®re 5 - Force -->
                        <circle cx="105" cy="65" r="20" fill="#CBD5E1"/>
                        <text x="105" y="70" text-anchor="middle" font-size="12" fill="white">üí™</text>
                        <text x="65" y="50" text-anchor="middle" font-size="8" fill="#64748B">Force ?</text>
                        <!-- L√©gende -->
                        <rect x="20" y="10" width="70" height="20" rx="4" fill="#10B981"/>
                        <text x="55" y="24" text-anchor="middle" font-size="8" fill="white" font-weight="600">‚â• 3 = Fragile</text>
                        <rect x="20" y="35" width="70" height="18" rx="4" fill="#F59E0B"/>
                        <text x="55" y="47" text-anchor="middle" font-size="8" fill="white">1-2 = Pr√©-fragile</text>
                    </svg>`
                }
            },
            {
                id: 9,
                category: "Douleur",
                case: "Mme Rousseau, <strong>91 ans</strong>, EHPAD, d√©mence mod√©r√©e (MMS 16), ne verbalise plus. L'√©quipe note qu'elle grimace lors de la toilette, a les poings serr√©s, refuse de s'alimenter depuis 2 jours.",
                question: "Quel outil d'√©valuation de la douleur est le plus appropri√© ?",
                options: [
                    "√âchelle Num√©rique (EN)",
                    "√âchelle Visuelle Analogique (EVA)",
                    "√âchelle ALGOPLUS",
                    "√âchelle verbale simple"
                ],
                correct: 2,
                explanation: "Chez un patient non communicant (d√©mence avanc√©e), l'auto-√©valuation (EN, EVA, EVS) est impossible. ALGOPLUS est une √©chelle d'h√©t√©ro-√©valuation valid√©e pour la douleur aigu√´, observant 5 items comportementaux : visage, regard, plaintes, corps, comportements. Score ‚â• 2 = douleur pr√©sente.",
                diagram: {
                    title: "√âchelle ALGOPLUS - 5 items",
                    svg: `<svg viewBox="0 0 400 200" xmlns="http://www.w3.org/2000/svg">
                        <!-- Header -->
                        <rect x="100" y="5" width="200" height="25" rx="6" fill="#7C3AED"/>
                        <text x="200" y="22" text-anchor="middle" font-size="11" fill="white" font-weight="700">ALGOPLUS (0-5)</text>
                        <!-- Items -->
                        <rect x="20" y="40" width="170" height="35" rx="6" fill="#FEE2E2" stroke="#EF4444"/>
                        <text x="30" y="55" font-size="10" fill="#991B1B" font-weight="600">1. Visage</text>
                        <text x="30" y="68" font-size="8" fill="#991B1B">Froncement sourcils, grimaces ‚úì</text>
                        <rect x="210" y="40" width="170" height="35" rx="6" fill="#F1F5F9" stroke="#CBD5E1"/>
                        <text x="220" y="55" font-size="10" fill="#475569" font-weight="600">2. Regard</text>
                        <text x="220" y="68" font-size="8" fill="#64748B">Inattentif, fixe, lointain</text>
                        <rect x="20" y="85" width="170" height="35" rx="6" fill="#F1F5F9" stroke="#CBD5E1"/>
                        <text x="30" y="100" font-size="10" fill="#475569" font-weight="600">3. Plaintes</text>
                        <text x="30" y="113" font-size="8" fill="#64748B">G√©missements, cris</text>
                        <rect x="210" y="85" width="170" height="35" rx="6" fill="#FEE2E2" stroke="#EF4444"/>
                        <text x="220" y="100" font-size="10" fill="#991B1B" font-weight="600">4. Corps</text>
                        <text x="220" y="113" font-size="8" fill="#991B1B">Poings serr√©s, raideur ‚úì</text>
                        <rect x="115" y="130" width="170" height="35" rx="6" fill="#FEE2E2" stroke="#EF4444"/>
                        <text x="125" y="145" font-size="10" fill="#991B1B" font-weight="600">5. Comportement</text>
                        <text x="125" y="158" font-size="8" fill="#991B1B">Refus alimentaire, agitation ‚úì</text>
                        <!-- Score -->
                        <rect x="140" y="175" width="120" height="22" rx="11" fill="#EF4444"/>
                        <text x="200" y="190" text-anchor="middle" font-size="10" fill="white" font-weight="700">Score ‚â• 2 ‚Üí Douleur</text>
                    </svg>`
                }
            },
            {
                id: 10,
                category: "Polym√©dication",
                case: "M. Leroy, <strong>86 ans</strong>, prend 12 m√©dicaments quotidiens. Vous r√©visez son ordonnance. Parmi ses traitements : IPP depuis 15 ans \"pour prot√©ger l'estomac\", zopiclone depuis 8 ans, hydroxyzine si besoin.",
                question: "Quel m√©dicament est le plus urgent √† d√©prescrire ?",
                options: [
                    "L'IPP (risque fracturaire, infections)",
                    "Le zopiclone (risque de chute, d√©pendance)",
                    "L'hydroxyzine (effets anticholinergiques)",
                    "Les trois sont √©quivalents en termes de risque"
                ],
                correct: 1,
                explanation: "Le zopiclone (benzodiaz√©pine-like) est prioritaire car il cumule : risque de chute majeur, troubles cognitifs, d√©pendance, efficacit√© diminu√©e au long cours. L'hydroxyzine a des effets anticholinergiques (confusion, r√©tention urinaire). L'IPP au long cours a des risques mais moins imm√©diats.",
                diagram: {
                    title: "Pyramide de risque - D√©prescription",
                    svg: `<svg viewBox="0 0 400 200" xmlns="http://www.w3.org/2000/svg">
                        <!-- Pyramide -->
                        <polygon points="200,15 320,180 80,180" fill="#F1F5F9" stroke="#CBD5E1" stroke-width="2"/>
                        <!-- Niveau 1 - URGENT -->
                        <polygon points="200,15 240,70 160,70" fill="#EF4444"/>
                        <text x="200" y="50" text-anchor="middle" font-size="9" fill="white" font-weight="700">URGENT</text>
                        <!-- Niveau 2 - IMPORTANT -->
                        <polygon points="160,70 240,70 270,120 130,120" fill="#F59E0B"/>
                        <text x="200" y="100" text-anchor="middle" font-size="9" fill="white" font-weight="700">IMPORTANT</text>
                        <!-- Niveau 3 - √Ä R√â√âVALUER -->
                        <polygon points="130,120 270,120 320,180 80,180" fill="#FEF3C7"/>
                        <text x="200" y="155" text-anchor="middle" font-size="9" fill="#92400E" font-weight="700">√Ä R√â√âVALUER</text>
                        <!-- Labels droite -->
                        <rect x="280" y="25" width="110" height="40" rx="6" fill="#EF4444"/>
                        <text x="335" y="42" text-anchor="middle" font-size="8" fill="white" font-weight="600">ZOPICLONE</text>
                        <text x="335" y="55" text-anchor="middle" font-size="7" fill="white">Chutes, d√©pendance</text>
                        <line x1="240" y1="45" x2="280" y2="45" stroke="#EF4444" stroke-width="2"/>
                        <rect x="290" y="75" width="100" height="35" rx="6" fill="#F59E0B"/>
                        <text x="340" y="90" text-anchor="middle" font-size="8" fill="white" font-weight="600">HYDROXYZINE</text>
                        <text x="340" y="102" text-anchor="middle" font-size="7" fill="white">Anticholinergique</text>
                        <line x1="255" y1="95" x2="290" y2="95" stroke="#F59E0B" stroke-width="2"/>
                        <rect x="300" y="130" width="90" height="35" rx="6" fill="#FEF3C7" stroke="#F59E0B"/>
                        <text x="345" y="145" text-anchor="middle" font-size="8" fill="#92400E" font-weight="600">IPP</text>
                        <text x="345" y="157" text-anchor="middle" font-size="7" fill="#92400E">Fractures, infections</text>
                        <line x1="285" y1="150" x2="300" y2="150" stroke="#F59E0B" stroke-width="2"/>
                        <!-- Risque chute -->
                        <rect x="10" y="30" width="80" height="50" rx="6" fill="#7C3AED"/>
                        <text x="50" y="50" text-anchor="middle" font-size="20">‚ö†Ô∏è</text>
                        <text x="50" y="70" text-anchor="middle" font-size="8" fill="white" font-weight="600">CHUTE ++</text>
                    </svg>`
                }
            }
        ];

        // State
        let state = {
            totalXP: 0,
            currentStreak: 0,
            bestStreak: 0,
            totalAnswers: 0,
            correctAnswersCount: 0,
            perfectSessions: 0,
            unlockedBadges: [],
            lastPlayDate: null,
            currentQuestionIndex: 0,
            sessionXP: 0,
            sessionCorrect: 0,
            answered: false,
            shuffledCases: []
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadState();
            updateUI();
            renderBadges();
        });

        // Load/Save State
        function loadState() {
            const saved = localStorage.getItem('geriaquest-state');
            if (saved) {
                state = { ...state, ...JSON.parse(saved) };
            }
            checkDailyStreak();
        }

        function saveState() {
            localStorage.setItem('geriaquest-state', JSON.stringify(state));
        }

        function checkDailyStreak() {
            const today = new Date().toDateString();
            const yesterday = new Date(Date.now() - 86400000).toDateString();

            if (state.lastPlayDate === yesterday) {
                // Streak continues
            } else if (state.lastPlayDate !== today) {
                // Streak broken
                state.currentStreak = 0;
            }
        }

        // Update UI
        function updateUI() {
            // Stats
            document.getElementById('totalXP').textContent = state.totalXP;
            document.getElementById('correctAnswers').textContent = state.correctAnswersCount;
            const accuracy = state.totalAnswers > 0
                ? Math.round((state.correctAnswersCount / state.totalAnswers) * 100)
                : 0;
            document.getElementById('accuracy').textContent = accuracy + '%';
            document.getElementById('streakCount').textContent = state.currentStreak;

            // Level
            const level = getCurrentLevel();
            document.getElementById('levelIcon').textContent = level.icon;
            document.getElementById('levelName').textContent = level.name;
            document.getElementById('levelSubtitle').textContent = `Niveau ${LEVELS.indexOf(level) + 1}`;
            document.getElementById('currentXP').textContent = state.totalXP;
            document.getElementById('nextLevelXP').textContent = level.maxXP === Infinity ? '‚àû' : level.maxXP;

            // XP Bar
            const progress = level.maxXP === Infinity
                ? 100
                : ((state.totalXP - level.minXP) / (level.maxXP - level.minXP)) * 100;
            document.getElementById('xpFill').style.width = Math.min(progress, 100) + '%';
        }

        function getCurrentLevel() {
            return LEVELS.find(l => state.totalXP >= l.minXP && state.totalXP < l.maxXP) || LEVELS[LEVELS.length - 1];
        }

        // Badges
        function renderBadges() {
            const grid = document.getElementById('badgesGrid');
            grid.innerHTML = BADGES.map(badge => {
                const unlocked = state.unlockedBadges.includes(badge.id);
                return `
                    <div class="badge-item ${unlocked ? 'unlocked' : 'locked'}">
                        <div class="badge-icon">${badge.icon}</div>
                        <div class="badge-name">${badge.name}</div>
                    </div>
                `;
            }).join('');
        }

        function checkBadges() {
            BADGES.forEach(badge => {
                if (!state.unlockedBadges.includes(badge.id) && badge.condition(state)) {
                    state.unlockedBadges.push(badge.id);
                    showToast(`üèÜ Badge d√©bloqu√© : ${badge.name}`, 'badge-toast');
                    renderBadges();
                }
            });
        }

        // Quiz Functions
        function startQuiz() {
            state.currentQuestionIndex = 0;
            state.sessionXP = 0;
            state.sessionCorrect = 0;
            state.answered = false;
            state.shuffledCases = shuffleArray([...CASES]);

            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('quizCard').style.display = 'block';
            document.getElementById('completeScreen').classList.remove('show');
            document.getElementById('totalQuestions').textContent = state.shuffledCases.length;

            loadQuestion();
        }

        function loadQuestion() {
            const currentCase = state.shuffledCases[state.currentQuestionIndex];
            state.answered = false;

            document.getElementById('currentQuestion').textContent = state.currentQuestionIndex + 1;
            document.getElementById('categoryName').textContent = currentCase.category;
            document.getElementById('caseText').innerHTML = currentCase.case;
            document.getElementById('questionText').textContent = currentCase.question;

            // Shuffle options but remember correct index
            const optionsWithIndex = currentCase.options.map((opt, idx) => ({ text: opt, originalIndex: idx }));
            const shuffledOptions = shuffleArray(optionsWithIndex);
            const newCorrectIndex = shuffledOptions.findIndex(o => o.originalIndex === currentCase.correct);

            const optionsList = document.getElementById('optionsList');
            optionsList.innerHTML = shuffledOptions.map((opt, idx) => `
                <button class="option-btn" onclick="selectAnswer(${idx}, ${newCorrectIndex})" data-index="${idx}">
                    <span class="option-letter">${String.fromCharCode(65 + idx)}</span>
                    <span class="option-text">${opt.text}</span>
                </button>
            `).join('');

            // Store explanation for later
            document.getElementById('explanationText').textContent = currentCase.explanation;

            // Setup schema if available
            const schemaContainer = document.getElementById('schemaContainer');
            if (currentCase.diagram) {
                document.getElementById('schemaTitle').textContent = currentCase.diagram.title;
                document.getElementById('schemaContent').innerHTML = currentCase.diagram.svg;
                schemaContainer.style.display = 'block';
            } else {
                schemaContainer.style.display = 'none';
            }

            // Hide explanation and next button
            document.getElementById('explanation').classList.remove('show', 'wrong-answer');
            document.getElementById('nextBtn').classList.remove('show');
        }

        function selectAnswer(selectedIdx, correctIdx) {
            if (state.answered) return;
            state.answered = true;

            const buttons = document.querySelectorAll('.option-btn');
            const isCorrect = selectedIdx === correctIdx;

            buttons.forEach((btn, idx) => {
                btn.disabled = true;
                if (idx === correctIdx) {
                    btn.classList.add('correct');
                } else if (idx === selectedIdx && !isCorrect) {
                    btn.classList.add('wrong');
                }
            });

            // Update state
            state.totalAnswers++;
            let xpGained = 0;

            if (isCorrect) {
                state.correctAnswersCount++;
                state.sessionCorrect++;
                state.currentStreak++;
                if (state.currentStreak > state.bestStreak) {
                    state.bestStreak = state.currentStreak;
                }
                xpGained = 10 + (state.currentStreak >= 3 ? 5 : 0); // Bonus streak
                state.totalXP += xpGained;
                state.sessionXP += xpGained;
            } else {
                state.currentStreak = 0;
            }

            // Show explanation
            const explanation = document.getElementById('explanation');
            const explanationIcon = document.getElementById('explanationIcon');
            const explanationTitle = document.getElementById('explanationTitle');
            const xpGainedEl = document.getElementById('xpGained');

            if (isCorrect) {
                explanation.classList.remove('wrong-answer');
                explanationIcon.textContent = '‚úì';
                explanationTitle.textContent = 'Bonne r√©ponse !';
                xpGainedEl.innerHTML = `+${xpGained} XP ${state.currentStreak >= 3 ? 'üî•' : ''}`;
                xpGainedEl.style.display = 'inline-flex';
            } else {
                explanation.classList.add('wrong-answer');
                explanationIcon.textContent = '‚úó';
                explanationTitle.textContent = 'Mauvaise r√©ponse';
                xpGainedEl.style.display = 'none';
            }

            explanation.classList.add('show');
            document.getElementById('nextBtn').classList.add('show');

            // Update date
            state.lastPlayDate = new Date().toDateString();

            // Check badges and save
            checkBadges();
            saveState();
            updateUI();
        }

        function nextQuestion() {
            state.currentQuestionIndex++;

            if (state.currentQuestionIndex >= state.shuffledCases.length) {
                endQuiz();
            } else {
                loadQuestion();
            }
        }

        function endQuiz() {
            // Check for perfect session
            if (state.sessionCorrect === state.shuffledCases.length) {
                state.perfectSessions++;
                checkBadges();
                saveState();
            }

            document.getElementById('quizCard').style.display = 'none';
            document.getElementById('finalCorrect').textContent = state.sessionCorrect + '/' + state.shuffledCases.length;
            document.getElementById('finalXP').textContent = '+' + state.sessionXP;
            document.getElementById('completeScreen').classList.add('show');

            if (state.sessionCorrect === state.shuffledCases.length) {
                showToast('üéØ Session parfaite !', 'success');
            }
        }

        function restartQuiz() {
            document.getElementById('completeScreen').classList.remove('show');
            document.getElementById('startScreen').style.display = 'block';
        }

        // Utilities
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        function showToast(message, type = '') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>

    <!-- Supabase Auth ‚Äî Scripts d'authentification -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/auth-guard.js"></script>
</body>
</html>
